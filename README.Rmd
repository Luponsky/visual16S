---
title: "visual16S package demo"
author: "yeguanhua"
output: github_document
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, 
                      fig.width=10, fig.height=6)
```

# Install and load package

Note: 

You need to run install from the parent working directory that contains the visual16S folder.

```{r install, eval=FALSE}
devtools::install('visual16S')
```

#### If you can't install package in R Console, try this: open visual16S.Rproj first, then use RStudio → Build → Install and Restart.

# Load package and demo data.

```{r load}
rm(list = ls())
library(visual16S)
demo_phyloseq_object <- visual16S::demo_phyloseq_object
demo_dada2_result <- visual16S::demo_dada2_result
```

# Data status

Primer: 

CCTAYGGGRBGCASCAG ; GGACTACNNGGGTATCTAAT

DADA2 filter parameters: 

dada2::filterAndTrim(truncLen=c(0,0), maxEE=c(2,2))

DADA2 taxonomy database: 

silva_nr_v132

Metadata: 

```{r matadata, echo=FALSE}
metadata <- extract_metadata_phyloseq(demo_phyloseq_object) %>% 
  arrange(diagnosis)
knitr::kable(metadata, format="markdown")
```

# DADA2 workflow reads track

First use the track_reads_dada2 function to check reads drop associated with every step in DADA2.

Note:

You can plot reads track in either absolute abundance or relative abundance.

If the sample size is too large to show on legend, set legend_position to "none".

```{r reads track, fig.height=8, fig.width=10}
track_reads_dada2(demo_dada2_result$reads_track, single_end = FALSE, 
                  relative_abundance = TRUE, legend_position = "top")
```

# Stacked bar plot of phylogenetic composition

Use plot_stacked_bar function to plot the Order level abundance in every sample. You can change the 'level' argument to plot abundance in different level, or change the 'feature' to choose different feature you want to show in x-axis.

Note: 

If the legend is too much to show, set legend_position to "none".

### Order level

```{r Stacked bar plot, fig.height=10}
plot_stacked_bar(phyloseq = demo_phyloseq_object, level = "Order", 
                 feature = "diagnosis", x_size = 8, legend_position = "top", 
                 legend_size = 10)
```

# Alpha diversity

Use plot_alpha_diversity to plot alpha diversity. Change 'measures' argument to use different measurement.

### Chao1

```{r Chao1}
plot_alpha_diversity(phyloseq = demo_phyloseq_object, feature = "diagnosis", 
                     feature2 = NA, measures = "Chao1", p_test = "kruskal")
```

# Beta diversity

Use plot_beta_diversity to plot beta diversity. Change 'method' to draw different beta diversity plot.

### Bray-Curtis

```{r Bray-Curtis}
plot_beta_diversity(phyloseq = demo_phyloseq_object, feature = "diagnosis", 
                    feature2 = NA, method = "bray")
```

# Log2 fold change

Use log2fc function to show differential analysis result.

```{r log2fc 1}
log2fc(phyloseq = demo_phyloseq_object, feature = "diagnosis", level = NA, 
       p_value = 0.05)
```

Choose log2fc reference and treatment by 'reference' and 'treatment' parameters. Both should be one of the levels in 'feature'.

```{r log2fc 2}
log2fc(phyloseq = demo_phyloseq_object, feature = "diagnosis", level = NA, 
       p_value = 0.05, reference = 'healthy', treatment = 'liver cancer')
```
