---
title: "visual16S package demo"
author: "yeguanhua"
output: github_document
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width=10, fig.height=6)
```

# Install dependencies

Before install the visual16S, there are some packages needed to be manually install from Bioconductor.

```{r dependancy, eval=FALSE}
if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")
BiocManager::install(c("dada2", "phyloseq", "DESeq2", "EnhancedVolcano"))
```


# Install and load package

Note: 

You need to run install from the parent working directory that contains the visual16S folder.

```{r install, eval=FALSE}
devtools::install('visual16S')
```

#### If you can't install package in R Console, try this: open visual16S.Rproj first, then use RStudio → Build → Install and Restart.

# Load package and demo data.

```{r load}
library(visual16S)
demo_phyloseq_object <- visual16S::demo_phyloseq_object
demo_dada2_result <- visual16S::demo_dada2_result
```

# Data status

Primer: 

CCTAYGGGRBGCASCAG ; GGACTACNNGGGTATCTAAT

DADA2 filter parameters: 

dada2::filterAndTrim(truncLen=c(0,0), maxEE=c(2,2))

DADA2 taxonomy database: 

silva_nr_v132

Metadata: 

```{r matadata, echo=FALSE}
extract_metadata_phyloseq(demo_phyloseq_object) %>% arrange(diagnosis) %>% knitr::kable()
```

# DADA2 workflow reads track

First use the track_reads_dada2 function to check reads drop associated with every step in DADA2.

Note:

You can plot reads track in either absolute abundance or relative abundance.

If the sample size is too large to show on legend, set legend_position to "none".

```{r track reads, fig.height=8, fig.width=10}
track_reads_dada2(demo_dada2_result$reads_track, 
                  single_end = FALSE, 
                  relative_abundance = TRUE, 
                  legend_position = "top")
```

# Stacked barplot of phylogenetic composition

Use plot_stacked_bar function to plot the taxonomy level abundance in every sample. You can change the 'level' argument to plot abundance in different level, or change the 'feature' to choose different feature you want to show in x-axis.

### Minimum usage

```{r Stacked barplot 1, fig.height=10}
plot_stacked_bar(phyloseq = demo_phyloseq_object, 
                 level = "Family")
```

### If legends are too many to show, set legend_position to "none"

```{r Stacked barplot 2, fig.height=10}
plot_stacked_bar(phyloseq = demo_phyloseq_object, 
                 level = "Family", 
                 legend_position = "none")
```

### If you want to show feature information in x-axis, set "feature" parameter

```{r Stacked barplot 3, fig.height=10}
plot_stacked_bar(phyloseq = demo_phyloseq_object, 
                 level = "Family", 
                 legend_position = "none", 
                 feature = "diagnosis")
```

### If you want the sample in specific order, pass ordered sample names to "order" parameter

```{r Stacked barplot 4, fig.height=10}
sample_order <- sample_names(demo_phyloseq_object)
plot_stacked_bar(phyloseq = demo_phyloseq_object, 
                 level = "Family", 
                 legend_position = "none", 
                 feature = "diagnosis", 
                 order = sample_order)
```

### You can also plot in relative abundance by setting "relative_abundance" to "TRUE"

```{r Stacked barplot 5, fig.height=10}
sample_order <- sample_names(demo_phyloseq_object)
plot_stacked_bar(phyloseq = demo_phyloseq_object, 
                 level = "Family", 
                 legend_position = "none", 
                 feature = "diagnosis", 
                 order = sample_order, 
                 relative_abundance = TRUE)
```

# Alpha diversity

Use plot_alpha_diversity to plot alpha diversity. 

### All alpha diversity

```{r All alpha}
plot_alpha_diversity(phyloseq = demo_phyloseq_object, 
                     feature = "diagnosis") %>% 
  # Show result in a table in markdown
  knitr::kable()
```

Or you can change 'measures' argument to use different measurement.

### Chao1

```{r Chao1}
plot_alpha_diversity(phyloseq = demo_phyloseq_object, 
                     feature = "diagnosis", 
                     measures = "Chao1", 
                     p_test = "kruskal")
```

# Beta diversity

Use plot_beta_diversity to plot beta diversity. Change 'method' to draw different beta diversity plot. You can locate specific sample in beta diversity plot by the table printed to the screen.

### Bray-Curtis

```{r Bray-Curtis}
plot_beta_diversity(phyloseq = demo_phyloseq_object, 
                    feature = "diagnosis", 
                    method = "bray")
```

# Log2 fold change

Use log2fc function to show differential analysis result.

```{r log2fc 1}
log2fc(phyloseq = demo_phyloseq_object, 
       feature = "diagnosis", 
       p_value = 0.05)
```

Choose log2fc reference and treatment by 'reference' and 'treatment' parameters. Both should be one of the levels in 'feature'.

```{r log2fc 2}
log2fc(phyloseq = demo_phyloseq_object, 
       feature = "diagnosis", 
       p_value = 0.05, 
       reference = 'healthy', 
       treatment = 'liver cancer')
```
